// Author: é‡‘ä¹¦è®°
//
//! æƒé™æ£€æŸ¥å®
//! 
//! æä¾›ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ï¼Œæ”¯æŒé€šé…ç¬¦å’Œç²¾ç¡®åŒ¹é…

use proc_macro::TokenStream;
use proc_macro2::TokenStream as TokenStream2;
use quote::quote;
use syn::{parse_macro_input, ItemFn, LitStr, Error};

/// æ£€æŸ¥æƒé™çš„å®
/// 
/// ä½¿ç”¨æ­¤å®æ ‡æ³¨çš„å‡½æ•°ä¼šåœ¨æ‰§è¡Œå‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŒ‡å®šæƒé™ã€‚
/// 
/// # å‚æ•°
/// 
/// - `permission` - æƒé™æ ‡è¯†ç¬¦ï¼Œæ”¯æŒä»¥ä¸‹æ ¼å¼ï¼š
///   - ç²¾ç¡®åŒ¹é…: `"user:delete"`
///   - é€šé…ç¬¦: `"admin:*"` (è¡¨ç¤º admin æ¨¡å—çš„æ‰€æœ‰æƒé™)
///   - å…¨å±€é€šé…ç¬¦: `"*"` (è¡¨ç¤ºæ‰€æœ‰æƒé™)
/// 
/// # å·¥ä½œåŸç†
/// 
/// 1. ç¼–è¯‘æ—¶ï¼šéªŒè¯æƒé™æ ¼å¼å¹¶æ·»åŠ å…ƒæ•°æ®æ ‡è®°
/// 2. è¿è¡Œæ—¶ï¼šä¸­é—´ä»¶è¯»å–æƒé™æ ‡è¯†å¹¶éªŒè¯
/// 3. éªŒè¯å¤±è´¥ï¼šè¿”å› 403 Forbidden
/// 
/// # ç¤ºä¾‹
/// 
/// ```rust,ignore
/// use axum::Json;
/// use sa_token_macro::sa_check_permission;
/// 
/// // æ£€æŸ¥å•ä¸ªæƒé™
/// #[sa_check_permission("user:delete")]
/// async fn delete_user(id: u64) -> &'static str {
///     "User deleted"
/// }
/// 
/// // ä½¿ç”¨é€šé…ç¬¦
/// #[sa_check_permission("admin:*")]
/// async fn admin_panel() -> &'static str {
///     "Admin panel"
/// }
/// 
/// // å…¨å±€æƒé™
/// #[sa_check_permission("*")]
/// async fn super_admin() -> &'static str {
///     "Super admin area"
/// }
/// ```
/// 
/// # æƒé™å‘½åè§„èŒƒ
/// 
/// æ¨èä½¿ç”¨ `æ¨¡å—:æ“ä½œ` çš„æ ¼å¼ï¼š
/// - `user:list` - æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
/// - `user:create` - åˆ›å»ºç”¨æˆ·
/// - `user:update` - æ›´æ–°ç”¨æˆ·
/// - `user:delete` - åˆ é™¤ç”¨æˆ·
/// - `order:*` - è®¢å•æ¨¡å—æ‰€æœ‰æƒé™
pub fn sa_check_permission_impl(attr: TokenStream, item: TokenStream) -> TokenStream {
    let permission = parse_macro_input!(attr as LitStr);
    let perm_value = permission.value();
    
    // ç¼–è¯‘æ—¶éªŒè¯ï¼šæƒé™æ ‡è¯†ç¬¦ä¸èƒ½ä¸ºç©º
    if perm_value.trim().is_empty() {
        let err = Error::new_spanned(&permission, "Permission identifier cannot be empty");
        return TokenStream::from(err.to_compile_error());
    }
    
    let input = parse_macro_input!(item as ItemFn);
    
    // æå–å‡½æ•°ç­¾åçš„å„ä¸ªéƒ¨åˆ†
    let fn_name = &input.sig.ident;
    let fn_inputs = &input.sig.inputs;
    let fn_output = &input.sig.output;
    let fn_body = &input.block;
    let fn_attrs = &input.attrs;
    let fn_vis = &input.vis;
    let fn_asyncness = &input.sig.asyncness;
    let fn_generics = &input.sig.generics;
    let fn_where_clause = &input.sig.generics.where_clause;
    
    // ç”Ÿæˆå¸¦æœ‰å…ƒæ•°æ®æ ‡è®°çš„å‡½æ•°
    let expanded: TokenStream2 = quote! {
        // ä¿ç•™åŸæœ‰å±æ€§
        #(#fn_attrs)*
        // æ·»åŠ å…ƒæ•°æ®æ ‡è®°ï¼ˆä¾›ä¸­é—´ä»¶è¯†åˆ«ï¼‰
        #[doc(hidden)]
        #[cfg_attr(feature = "sa-token-metadata", sa_token_check = "permission")]
        #[cfg_attr(feature = "sa-token-metadata", sa_token_permission = #perm_value)]
        #fn_vis #fn_asyncness fn #fn_name #fn_generics(#fn_inputs) #fn_output #fn_where_clause {
            // æ³¨æ„ï¼š
            // - æƒé™æ£€æŸ¥é€»è¾‘åœ¨ä¸­é—´ä»¶ä¸­æ‰§è¡Œ
            // - æ‰€éœ€æƒé™: #perm_value
            // - æ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼ˆå¦‚ admin:* åŒ¹é… admin:readã€admin:writeï¼‰
            
            #fn_body
        }
    };
    
    expanded.into()
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ“– ä»£ç æµç¨‹è¯´æ˜ - æƒé™æ£€æŸ¥
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
// é—®é¢˜ï¼šä¸ºä»€ä¹ˆå®ä¸­æ²¡æœ‰çœ‹åˆ°å®é™…çš„æƒé™æ£€æŸ¥é€»è¾‘ï¼Ÿ
// ç­”æ¡ˆï¼šæƒé™æ£€æŸ¥é€»è¾‘åœ¨ä¸šåŠ¡ä»£ç æˆ–ä¸­é—´ä»¶ä¸­ï¼Œå®åªè´Ÿè´£æ ‡è®°æ‰€éœ€æƒé™ã€‚
//
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// å®Œæ•´æƒé™æ£€æŸ¥æµç¨‹
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
// ã€æ­¥éª¤ 1ã€‘ç¼–è¯‘æ—¶ - å®å±•å¼€ï¼ˆæœ¬æ–‡ä»¶ï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// ç”¨æˆ·ä»£ç ï¼š
// ```rust
// #[sa_check_permission("user:delete")]
// async fn delete_user(id: u64) -> &'static str {
//     "User deleted"
// }
// ```
//
// å®å±•å¼€åï¼š
// ```rust
// #[cfg_attr(feature = "sa-token-metadata", sa_token_check = "permission")]
// #[cfg_attr(feature = "sa-token-metadata", sa_token_permission = "user:delete")]
// async fn delete_user(id: u64) -> &'static str {
//     "User deleted"
// }
// ```
//
// å…³é”®ç‚¹ï¼š
// - ç¼–è¯‘æ—¶éªŒè¯ï¼šæƒé™æ ‡è¯†ç¬¦ä¸èƒ½ä¸ºç©º
// - æ·»åŠ å…ƒæ•°æ®ï¼šè®°å½•æ‰€éœ€æƒé™ "user:delete"
// - å‡½æ•°ä½“ä¸å˜ï¼šä¸æ’å…¥ä»»ä½•æƒé™æ£€æŸ¥ä»£ç 
//
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
// ã€æ­¥éª¤ 2ã€‘åº”ç”¨å¯åŠ¨ - æƒé™é…ç½®ï¼ˆä¸šåŠ¡ä»£ç ï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// ä½ç½®ï¼šmain.rs æˆ–åˆå§‹åŒ–ä»£ç 
//
// ```rust
// // åˆå§‹åŒ–æƒé™æ•°æ®ï¼ˆé€šå¸¸ä»æ•°æ®åº“åŠ è½½ï¼‰
// async fn init_permissions() {
//     // ä¸ºç”¨æˆ·è®¾ç½®æƒé™
//     StpUtil::set_permissions("user_123", vec![
//         "user:list".to_string(),
//         "user:create".to_string(),
//         "user:update".to_string(),
//         "user:delete".to_string(),  // â¬…ï¸ è¿™ä¸ªç”¨æˆ·æœ‰åˆ é™¤æƒé™
//     ]).await?;
//     
//     // ä¸ºç®¡ç†å‘˜è®¾ç½®æƒé™ï¼ˆä½¿ç”¨é€šé…ç¬¦ï¼‰
//     StpUtil::set_permissions("admin_001", vec![
//         "user:*".to_string(),    // â¬…ï¸ user æ¨¡å—çš„æ‰€æœ‰æƒé™
//         "order:*".to_string(),
//     ]).await?;
// }
// ```
//
// å…³é”®ç‚¹ï¼š
// - æƒé™å­˜å‚¨åœ¨å†…å­˜æˆ– Redis ä¸­
// - æ”¯æŒç²¾ç¡®åŒ¹é…å’Œé€šé…ç¬¦
// - æ¯ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªæƒé™
//
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
// ã€æ­¥éª¤ 3ã€‘è¿è¡Œæ—¶ - è¯·æ±‚å¤„ç†
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// 3.1 ä¸­é—´ä»¶æå– token å’Œ login_id
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// ä½ç½®ï¼šsa-token-plugin-axum/src/layer.rs
//
// ```rust
// impl<S> Service<Request<ReqBody>> for SaTokenMiddleware<S> {
//     fn call(&mut self, mut request: Request<ReqBody>) -> Self::Future {
//         Box::pin(async move {
//             // â¬‡ï¸ æå–å¹¶éªŒè¯ token
//             if let Some(token_str) = extract_token_from_request(&request) {
//                 let token = TokenValue::new(token_str);
//                 if state.manager.is_valid(&token).await {
//                     if let Ok(token_info) = state.manager.get_token_info(&token).await {
//                         // â¬‡ï¸ å­˜å‚¨ login_id åˆ°ä¸Šä¸‹æ–‡
//                         request.extensions_mut().insert(token_info.login_id.clone());
//                         ctx.login_id = Some(token_info.login_id);
//                     }
//                 }
//             }
//             
//             // â¬‡ï¸ ç»§ç»­å¤„ç†è¯·æ±‚
//             inner.call(request).await
//         })
//     }
// }
// ```
//
// 3.2 è·¯ç”±å¤„ç†å‡½æ•° - æƒé™æ£€æŸ¥ï¼ˆä¸¤ç§æ–¹å¼ï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// æ–¹å¼ Aï¼šåœ¨å‡½æ•°å†…æ‰‹åŠ¨æ£€æŸ¥ï¼ˆæ¨èï¼‰
// ```rust
// #[sa_check_permission("user:delete")]  // â¬…ï¸ å®æ ‡è®°æ‰€éœ€æƒé™
// async fn delete_user(id: u64) -> Result<&'static str, StatusCode> {
//     // â¬‡ï¸ æ‰‹åŠ¨æ£€æŸ¥æƒé™
//     let login_id = StpUtil::get_login_id_as_string()
//         .map_err(|_| StatusCode::UNAUTHORIZED)?;
//     
//     // â¬‡ï¸ éªŒè¯æ˜¯å¦æœ‰æƒé™
//     if !StpUtil::has_permission(&login_id, "user:delete").await {
//         return Err(StatusCode::FORBIDDEN);
//     }
//     
//     // â¬‡ï¸ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
//     // ... åˆ é™¤ç”¨æˆ·ä»£ç  ...
//     Ok("User deleted")
// }
// ```
//
// æ–¹å¼ Bï¼šä½¿ç”¨ check_permissionï¼ˆæŠ›å¼‚å¸¸ï¼‰
// ```rust
// #[sa_check_permission("user:delete")]
// async fn delete_user(id: u64) -> Result<&'static str, StatusCode> {
//     let login_id = StpUtil::get_login_id_as_string()?;
//     
//     // â¬‡ï¸ æ£€æŸ¥æƒé™ï¼Œå¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸
//     StpUtil::check_permission(&login_id, "user:delete").await?;
//     
//     Ok("User deleted")
// }
// ```
//
// å…³é”®ç‚¹ï¼š
// - å®åªæ ‡è®°æ‰€éœ€æƒé™ï¼Œä¸æ‰§è¡Œæ£€æŸ¥
// - å®é™…æ£€æŸ¥éœ€è¦æ‰‹åŠ¨è°ƒç”¨ StpUtil æ–¹æ³•
// - has_permission() è¿”å› bool
// - check_permission() å¤±è´¥ä¼šè¿”å› Err
//
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
// ã€æ­¥éª¤ 4ã€‘æƒé™åŒ¹é…é€»è¾‘
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// ä½ç½®ï¼šsa-token-core/src/util.rs
//
// ```rust
// pub async fn has_permission(login_id: impl LoginId, permission: &str) -> bool {
//     let manager = Self::get_manager();
//     let map = manager.user_permissions.read().await;
//     
//     if let Some(permissions) = map.get(&login_id.to_login_id()) {
//         // â¬‡ï¸ 1. ç²¾ç¡®åŒ¹é…
//         if permissions.contains(&permission.to_string()) {
//             return true;
//         }
//         
//         // â¬‡ï¸ 2. é€šé…ç¬¦åŒ¹é…
//         for perm in permissions {
//             if perm.ends_with(":*") {
//                 let prefix = &perm[..perm.len() - 2];
//                 if permission.starts_with(prefix) {
//                     return true;
//                 }
//             }
//         }
//     }
//     
//     false
// }
// ```
//
// åŒ¹é…è§„åˆ™ï¼š
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ç”¨æˆ·æƒé™         â”‚ è¯·æ±‚æƒé™         â”‚ æ˜¯å¦åŒ¹é… â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ user:delete      â”‚ user:delete      â”‚ âœ… ç²¾ç¡®  â”‚
// â”‚ user:*           â”‚ user:delete      â”‚ âœ… é€šé…  â”‚
// â”‚ user:*           â”‚ user:list        â”‚ âœ… é€šé…  â”‚
// â”‚ admin:*          â”‚ user:delete      â”‚ âŒ ä¸åŒ¹é…â”‚
// â”‚ user:read        â”‚ user:delete      â”‚ âŒ ä¸åŒ¹é…â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
// ã€æ€»ç»“ã€‘æƒé™æ£€æŸ¥çš„èŒè´£åˆ†ç¦»
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚  ç»„ä»¶           â”‚  èŒè´£                â”‚  æ‰§è¡Œæ—¶æœº                    â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ å® (æœ¬æ–‡ä»¶)     â”‚ æ ‡è®°æ‰€éœ€æƒé™         â”‚ ç¼–è¯‘æ—¶                       â”‚
// â”‚ åˆå§‹åŒ–ä»£ç       â”‚ é…ç½®ç”¨æˆ·æƒé™         â”‚ åº”ç”¨å¯åŠ¨æ—¶                   â”‚
// â”‚ ä¸­é—´ä»¶          â”‚ æå– token/login_id  â”‚ è¿è¡Œæ—¶ - è¯·æ±‚åˆ°è¾¾æ—¶          â”‚
// â”‚ ä¸šåŠ¡ä»£ç         â”‚ è°ƒç”¨æƒé™æ£€æŸ¥         â”‚ è¿è¡Œæ—¶ - å‡½æ•°å†…éƒ¨            â”‚
// â”‚ StpUtil         â”‚ æ‰§è¡Œæƒé™åŒ¹é…         â”‚ è¿è¡Œæ—¶ - è¢«è°ƒç”¨æ—¶            â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
// ã€ä¸ºä»€ä¹ˆéœ€è¦æ‰‹åŠ¨è°ƒç”¨æƒé™æ£€æŸ¥ï¼Ÿã€‘
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// âœ… ä¼˜ç‚¹ï¼š
// 1. çµæ´»æ€§ - å¯ä»¥åœ¨æ£€æŸ¥å‰åæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
// 2. é”™è¯¯å¤„ç† - å¯ä»¥è‡ªå®šä¹‰æƒé™ä¸è¶³æ—¶çš„å“åº”
// 3. åŠ¨æ€æƒé™ - å¯ä»¥æ ¹æ®ä¸šåŠ¡é€»è¾‘åŠ¨æ€å†³å®šæ£€æŸ¥å“ªäº›æƒé™
// 4. æ€§èƒ½ä¼˜åŒ– - åªåœ¨éœ€è¦æ—¶æ‰æ£€æŸ¥ï¼Œé¿å…ä¸å¿…è¦çš„æ•°æ®åº“æŸ¥è¯¢
//
// ç¤ºä¾‹ï¼š
// ```rust
// #[sa_check_permission("order:refund")]
// async fn refund_order(order_id: u64, amount: f64) -> Result<String, StatusCode> {
//     let login_id = StpUtil::get_login_id_as_string()?;
//     
//     // â¬‡ï¸ åŠ¨æ€æƒé™ï¼šé‡‘é¢è¶…è¿‡ 1000 éœ€è¦é¢å¤–çš„é«˜çº§æƒé™
//     let required_permission = if amount > 1000.0 {
//         "order:refund:advanced"
//     } else {
//         "order:refund"
//     };
//     
//     if !StpUtil::has_permission(&login_id, required_permission).await {
//         // â¬‡ï¸ è‡ªå®šä¹‰é”™è¯¯å“åº”
//         return Err(StatusCode::FORBIDDEN);
//     }
//     
//     Ok(format!("Refunded ${}", amount))
// }
// ```
//
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
//
// ã€æœªæ¥å¯èƒ½çš„å¢å¼ºã€‘è‡ªåŠ¨æƒé™æ£€æŸ¥ä¸­é—´ä»¶
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// å¯ä»¥å¼€å‘ä¸€ä¸ªä¸“é—¨çš„æƒé™æ£€æŸ¥ä¸­é—´ä»¶ï¼Œè‡ªåŠ¨è¯»å–å‡½æ•°çš„æƒé™æ ‡è®°å¹¶éªŒè¯ï¼š
//
// ```rust
// // æœªæ¥å¯èƒ½çš„å®ç°ï¼ˆéœ€è¦åå°„æˆ–ä»£ç ç”Ÿæˆï¼‰
// pub struct SaPermissionMiddleware;
//
// impl<S> Service<Request> for SaPermissionMiddleware<S> {
//     fn call(&mut self, request: Request) -> Self::Future {
//         // 1. ä»è·¯ç”±å…ƒæ•°æ®ä¸­è¯»å–æ‰€éœ€æƒé™
//         // 2. è‡ªåŠ¨è°ƒç”¨ StpUtil::has_permission()
//         // 3. å¦‚æœæ²¡æœ‰æƒé™ï¼Œç›´æ¥è¿”å› 403
//         // 4. æœ‰æƒé™åˆ™ç»§ç»­æ‰§è¡Œ
//     }
// }
// ```
//
// æ³¨æ„ï¼šå½“å‰ç‰ˆæœ¬éœ€è¦æ‰‹åŠ¨è°ƒç”¨ï¼Œå› ä¸ºï¼š
// - Rust ç¼ºå°‘è¿è¡Œæ—¶åå°„
// - cfg_attr çš„å…ƒæ•°æ®åœ¨è¿è¡Œæ—¶ä¸å¯è®¿é—®
// - éœ€è¦é¢å¤–çš„å·¥å…·æˆ–æ¡†æ¶æ”¯æŒ
//
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
