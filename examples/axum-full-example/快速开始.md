# 快速开始 - 权限标识使用指南

## 核心问题解答

### ❓ 问题：`#[sa_check_permission("user:list")]` 中的 `user:list` 怎么写入到 sa-token-rust 中？

### ✅ 答案：有三种方式

---

## 方式一：启动时初始化（最简单）

### 代码位置：`src/main.rs` 第 115-184 行

```rust
async fn init_test_permissions(service: &PermissionService) {
    // 为管理员添加权限
    service.add_user_permissions(
        "admin",  // 用户 ID
        vec![
            "user:list".to_string(),      // ⬅️ 在这里写入权限
            "user:create".to_string(),    // ⬅️ 在这里写入权限
            "user:delete".to_string(),    // ⬅️ 在这里写入权限
            "admin:*".to_string(),        // 通配符权限
        ],
    ).await;
}
```

### 如何使用：

1. **打开** `src/main.rs`
2. **找到** `init_test_permissions()` 函数
3. **添加** 你的权限字符串到 `vec![]` 中
4. **重启** 服务器

---

## 方式二：通过 API 动态添加（最灵活）

### 已提供的 API 接口：

| 接口 | 说明 |
|------|------|
| `GET /api/permission/list` | 查看所有用户权限 |
| `POST /api/permission/add` | 为用户添加权限 |
| `POST /api/permission/remove` | 移除用户权限 |
| `GET /api/role/list` | 查看所有用户角色 |

### 实际操作示例：

```bash
# 步骤 1：管理员登录
curl -X POST http://localhost:3000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 返回：{ "data": { "token": "your-token-here", ... } }

# 步骤 2：为用户添加权限
curl -X POST http://localhost:3000/api/permission/add \
  -H "Authorization: Bearer your-token-here" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user",
    "permission": "article:create"
  }'

# 步骤 3：确认权限已添加
curl -X GET http://localhost:3000/api/permission/list \
  -H "Authorization: Bearer your-token-here"
```

---

## 方式三：从数据库加载（生产环境）

### 代码位置：`src/permission.rs` 第 121-130 行

```rust
impl PermissionService {
    /// 从数据库加载用户权限
    pub async fn load_from_database(&self, user_id: &str) {
        // 1. 从数据库查询用户权限
        // let permissions = database.query_user_permissions(user_id).await?;
        
        // 2. 加载到内存
        // self.add_user_permissions(user_id, permissions).await;
    }
}
```

### 实现步骤：

1. **连接数据库**（使用 sqlx 或 diesel）
2. **查询权限数据**
3. **调用** `self.add_user_permissions()` 加载到内存

---

## 快速测试

### 1. 启动服务器

```bash
cd /Users/m1pro/rustproject/sa-token-rust/examples/axum-full-example
cargo run
```

### 2. 运行测试脚本

```bash
bash test.sh
```

### 3. 测试结果

你会看到：

```
✅ 管理员登录成功！
✅ 查看权限列表成功！
✅ 添加权限成功！
✅ 权限验证成功！
```

---

## 权限标识规范

### 推荐格式：`资源:操作`

```
user:list      - 查看用户列表
user:create    - 创建用户
user:update    - 更新用户
user:delete    - 删除用户
article:edit   - 编辑文章
system:config  - 系统配置
admin:*        - admin 命名空间所有权限
```

---

## 使用示例

### 在路由处理函数上使用

```rust
// 需要 user:list 权限
#[sa_check_permission("user:list")]
async fn list_users() -> Result<Json<Vec<User>>, ApiError> {
    // 业务逻辑
}

// 需要同时拥有两个权限
#[sa_check_permissions_and("user:read", "user:write")]
async fn manage_user() -> Result<Json<String>, ApiError> {
    // 业务逻辑
}

// 需要 admin 角色
#[sa_check_role("admin")]
async fn admin_panel() -> Result<Json<String>, ApiError> {
    // 业务逻辑
}

// 公开接口，不需要认证
#[sa_ignore]
async fn public_api() -> &'static str {
    "Hello"
}
```

---

## 完整文档

- **详细说明**：查看 `权限使用说明.md`
- **完整示例**：查看 `README.md`
- **测试脚本**：查看 `test.sh`

---

## 总结

写入权限标识到 sa-token-rust 就是这么简单：

1. **开发环境**：在 `init_test_permissions()` 函数中添加
2. **运行时**：通过 `/api/permission/add` API 添加
3. **生产环境**：在 `load_from_database()` 中从数据库加载

选择最适合你的方式即可！🎉

