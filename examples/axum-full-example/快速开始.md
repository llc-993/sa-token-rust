# å¿«é€Ÿå¼€å§‹ - æƒé™æ ‡è¯†ä½¿ç”¨æŒ‡å—

## æ ¸å¿ƒé—®é¢˜è§£ç­”

### â“ é—®é¢˜ï¼š`#[sa_check_permission("user:list")]` ä¸­çš„ `user:list` æ€ä¹ˆå†™å…¥åˆ° sa-token-rust ä¸­ï¼Ÿ

### âœ… ç­”æ¡ˆï¼šæœ‰ä¸‰ç§æ–¹å¼

---

## æ–¹å¼ä¸€ï¼šå¯åŠ¨æ—¶åˆå§‹åŒ–ï¼ˆæœ€ç®€å•ï¼‰

### ä»£ç ä½ç½®ï¼š`src/main.rs` ç¬¬ 115-184 è¡Œ

```rust
async fn init_test_permissions(service: &PermissionService) {
    // ä¸ºç®¡ç†å‘˜æ·»åŠ æƒé™
    service.add_user_permissions(
        "admin",  // ç”¨æˆ· ID
        vec![
            "user:list".to_string(),      // â¬…ï¸ åœ¨è¿™é‡Œå†™å…¥æƒé™
            "user:create".to_string(),    // â¬…ï¸ åœ¨è¿™é‡Œå†™å…¥æƒé™
            "user:delete".to_string(),    // â¬…ï¸ åœ¨è¿™é‡Œå†™å…¥æƒé™
            "admin:*".to_string(),        // é€šé…ç¬¦æƒé™
        ],
    ).await;
}
```

### å¦‚ä½•ä½¿ç”¨ï¼š

1. **æ‰“å¼€** `src/main.rs`
2. **æ‰¾åˆ°** `init_test_permissions()` å‡½æ•°
3. **æ·»åŠ ** ä½ çš„æƒé™å­—ç¬¦ä¸²åˆ° `vec![]` ä¸­
4. **é‡å¯** æœåŠ¡å™¨

---

## æ–¹å¼äºŒï¼šé€šè¿‡ API åŠ¨æ€æ·»åŠ ï¼ˆæœ€çµæ´»ï¼‰

### å·²æä¾›çš„ API æ¥å£ï¼š

| æ¥å£ | è¯´æ˜ |
|------|------|
| `GET /api/permission/list` | æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·æƒé™ |
| `POST /api/permission/add` | ä¸ºç”¨æˆ·æ·»åŠ æƒé™ |
| `POST /api/permission/remove` | ç§»é™¤ç”¨æˆ·æƒé™ |
| `GET /api/role/list` | æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·è§’è‰² |

### å®é™…æ“ä½œç¤ºä¾‹ï¼š

```bash
# æ­¥éª¤ 1ï¼šç®¡ç†å‘˜ç™»å½•
curl -X POST http://localhost:3000/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# è¿”å›ï¼š{ "data": { "token": "your-token-here", ... } }

# æ­¥éª¤ 2ï¼šä¸ºç”¨æˆ·æ·»åŠ æƒé™
curl -X POST http://localhost:3000/api/permission/add \
  -H "Authorization: Bearer your-token-here" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "user",
    "permission": "article:create"
  }'

# æ­¥éª¤ 3ï¼šç¡®è®¤æƒé™å·²æ·»åŠ 
curl -X GET http://localhost:3000/api/permission/list \
  -H "Authorization: Bearer your-token-here"
```

---

## æ–¹å¼ä¸‰ï¼šä»æ•°æ®åº“åŠ è½½ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### ä»£ç ä½ç½®ï¼š`src/permission.rs` ç¬¬ 121-130 è¡Œ

```rust
impl PermissionService {
    /// ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·æƒé™
    pub async fn load_from_database(&self, user_id: &str) {
        // 1. ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æƒé™
        // let permissions = database.query_user_permissions(user_id).await?;
        
        // 2. åŠ è½½åˆ°å†…å­˜
        // self.add_user_permissions(user_id, permissions).await;
    }
}
```

### å®ç°æ­¥éª¤ï¼š

1. **è¿æ¥æ•°æ®åº“**ï¼ˆä½¿ç”¨ sqlx æˆ– dieselï¼‰
2. **æŸ¥è¯¢æƒé™æ•°æ®**
3. **è°ƒç”¨** `self.add_user_permissions()` åŠ è½½åˆ°å†…å­˜

---

## å¿«é€Ÿæµ‹è¯•

### 1. å¯åŠ¨æœåŠ¡å™¨

```bash
cd /Users/m1pro/rustproject/sa-token-rust/examples/axum-full-example
cargo run
```

### 2. è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
bash test.sh
```

### 3. æµ‹è¯•ç»“æœ

ä½ ä¼šçœ‹åˆ°ï¼š

```
âœ… ç®¡ç†å‘˜ç™»å½•æˆåŠŸï¼
âœ… æŸ¥çœ‹æƒé™åˆ—è¡¨æˆåŠŸï¼
âœ… æ·»åŠ æƒé™æˆåŠŸï¼
âœ… æƒé™éªŒè¯æˆåŠŸï¼
```

---

## æƒé™æ ‡è¯†è§„èŒƒ

### æ¨èæ ¼å¼ï¼š`èµ„æº:æ“ä½œ`

```
user:list      - æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
user:create    - åˆ›å»ºç”¨æˆ·
user:update    - æ›´æ–°ç”¨æˆ·
user:delete    - åˆ é™¤ç”¨æˆ·
article:edit   - ç¼–è¾‘æ–‡ç« 
system:config  - ç³»ç»Ÿé…ç½®
admin:*        - admin å‘½åç©ºé—´æ‰€æœ‰æƒé™
```

---

## ä½¿ç”¨ç¤ºä¾‹

### åœ¨è·¯ç”±å¤„ç†å‡½æ•°ä¸Šä½¿ç”¨

```rust
// éœ€è¦ user:list æƒé™
#[sa_check_permission("user:list")]
async fn list_users() -> Result<Json<Vec<User>>, ApiError> {
    // ä¸šåŠ¡é€»è¾‘
}

// éœ€è¦åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªæƒé™
#[sa_check_permissions_and("user:read", "user:write")]
async fn manage_user() -> Result<Json<String>, ApiError> {
    // ä¸šåŠ¡é€»è¾‘
}

// éœ€è¦ admin è§’è‰²
#[sa_check_role("admin")]
async fn admin_panel() -> Result<Json<String>, ApiError> {
    // ä¸šåŠ¡é€»è¾‘
}

// å…¬å¼€æ¥å£ï¼Œä¸éœ€è¦è®¤è¯
#[sa_ignore]
async fn public_api() -> &'static str {
    "Hello"
}
```

---

## å®Œæ•´æ–‡æ¡£

- **è¯¦ç»†è¯´æ˜**ï¼šæŸ¥çœ‹ `æƒé™ä½¿ç”¨è¯´æ˜.md`
- **å®Œæ•´ç¤ºä¾‹**ï¼šæŸ¥çœ‹ `README.md`
- **æµ‹è¯•è„šæœ¬**ï¼šæŸ¥çœ‹ `test.sh`

---

## æ€»ç»“

å†™å…¥æƒé™æ ‡è¯†åˆ° sa-token-rust å°±æ˜¯è¿™ä¹ˆç®€å•ï¼š

1. **å¼€å‘ç¯å¢ƒ**ï¼šåœ¨ `init_test_permissions()` å‡½æ•°ä¸­æ·»åŠ 
2. **è¿è¡Œæ—¶**ï¼šé€šè¿‡ `/api/permission/add` API æ·»åŠ 
3. **ç”Ÿäº§ç¯å¢ƒ**ï¼šåœ¨ `load_from_database()` ä¸­ä»æ•°æ®åº“åŠ è½½

é€‰æ‹©æœ€é€‚åˆä½ çš„æ–¹å¼å³å¯ï¼ğŸ‰

